@{
    ViewBag.Title = "Mobicash to Retailers";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="content-header">
    @{

        Html.RenderPartial("_AlertBox");
    }
    <div class="panel panel-default ">
        <div class="panel-heading">
            <div class="pull-left">
                <h3 class="panel-title"> MobiCash to Retailers</h3>
            </div>
            <div class="pull-right">
                <button type="button" class="btn2 btn-primary"> <i class="fa fa-minus"></i> </button>
                <button type="button" class="btn2 btn-primary"> <i class="fa fa-window-maximize"></i> </button>
                <button type="button" class="btn2 btn-primary"> <i class="fa fa-close"></i> </button>
            </div>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-5">
                    <section class="panel panel-default no-background-bg">
                        <div class="panel-body ">
                            <div class="simpledata" id="SimpleData">
                                <form class="form-horizontal ng-pristine ng-valid" action="/Purchases/AddBalance" id="form1" role="form">
                                    <div class="form-group form-group-margin">
                                        <label for="inputEmail3" class="col-sm-3 no-gutters control-label">Date</label>
                                        <div class="col-sm-6 no-gutters">
                                            <input class="form-control text-fld-height required" required id="" name="Date" type="date">
                                        </div>
                                    </div>
                                    <div class="form-group form-group-margin">
                                        <label for="inputEmail3" class="col-sm-3 no-gutters control-label">Select DO</label>
                                        <div class="col-sm-9 no-gutters">
                                            <span class="ui-select">
                                                <select name="DistributorId" required class="DistributorId required required getbalance" id="DistributorId">
                                                    <option value="">--Select--</option>
                                                    @foreach (var list in ViewBag.dolist)
                                                    {
                                                        <option value="@list.Id">@list.Name</option>
                                                    }
                                                </select>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group form-group-margin">
                                        <label for="inputEmail3" class="col-sm-3 no-gutters control-label">Total Load</label>
                                        <div class="col-sm-6 no-gutters">
                                            <input class="form-control text-fld-height required" value="0" required id="TotalLoad" name="TLoad" type="text">
                                        </div>
                                    </div>
                                    <div class="form-group form-group-margin">
                                        <label for="inputEmail3" class="col-sm-3 no-gutters control-label">Total Back</label>
                                        <div class="col-sm-6 no-gutters">
                                            <input class="form-control text-fld-height required" value="0" required id="TotalBack" name="TBack" type="text">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group form-group-margin">
                                        <label for="inputEmail3" class="col-sm-3 no-gutters control-label">Balance</label>
                                        <div class="col-sm-6 no-gutters">
                                            <input class="form-control text-fld-height " value="0" id="TotalBalance" name="Balance" type="text">
                                        </div>
                                    </div>
                                    <!--End Form Group-->
                                </form>
                            </div>
                            <form class="form-horizontal ng-pristine ng-valid form2" id="form2" role="form" style="display:none;">
                                <div class="form-group form-group-margin">
                                    <label for="inputEmail3" class="col-sm-3 no-gutters control-label">Date</label>
                                    <div class="col-sm-6 no-gutters">
                                        <input class="form-control text-fld-height" type="date" id="PDate" name="Date" />
                                    </div>
                                </div>

                                <div class="form-group form-group-margin">
                                    <label for="inputEmail3" class="col-sm-3 no-gutters control-label">Select DO</label>
                                    <div class="col-sm-9 no-gutters">
                                        <span class="ui-select">
                                            <select name="DistributorId1" required class="DistributorId1 required getbalance" id="DistributorId1">
                                                <option value="">--Select--</option>
                                                @foreach (var list in ViewBag.dolist)
                                                {
                                                    <option value="@list.Id">@list.Name</option>
                                                }
                                            </select>
                                        </span>
                                    </div>
                                </div>
                                <!--     RESULTS*******      -->
                                <div class="form-group form-group-margin">
                                    <label for="inputEmail3" class="col-sm-3 no-gutters control-label">Total Load</label>
                                    <div class="col-sm-6 no-gutters">
                                        <input class="form-control text-fld-height required" value="0" required id="tload" name="TLoad" type="text">
                                    </div>
                                </div>
                                <div class="form-group form-group-margin">
                                    <label for="inputEmail3" class="col-sm-3 no-gutters control-label">Total Back</label>
                                    <div class="col-sm-6 no-gutters">
                                        <input class="form-control text-fld-height required" value="0" required id="tback" name="TBack" type="text">
                                    </div>
                                </div>

                                <div class="form-group form-group-margin">
                                    <label for="inputEmail3" class="col-sm-3 no-gutters control-label">Balance</label>
                                    <div class="col-sm-6 no-gutters">
                                        <input class="form-control text-fld-height " value="0" id="bal" name="Balance" type="text">
                                    </div>
                                </div>
                                <!--  ******   END*******      -->
                                <button class="btn btn-success SearchLoad btn-sm pull-left" type="button" style="margin-top: 20px;"><span class="glyphicon glyphicon-search "></span> Filter Result</button>
                            </form>
                        </div>
                    </section>
                </div>
                <div class="form1 col-md-12">
                    <div class="">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th style=" text-align:center;"><i class="fa fa-plus" aria-hidden="true"></i></th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Load</th>
                                    <th>Back</th>
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody class="AddGrid2">
                                
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            <div class="row form2" style="display:none;">
                <div class="col-md-12">
                    <div class="">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th style=" text-align:center;"><i class="fa fa-plus" aria-hidden="true"></i></th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Load</th>
                                    <th>Back</th>
                                    <th class="action">Action</th>
                                </tr>
                            </thead>
                            <tbody class="AddGrid"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
        <section class="content" style="min-height:400px;">
            <!-- Your Page Content Here -->
        </section>
    </div>
</section>
<!-- Main content -->
<section class="content" style="min-height:400px;">
    <!-- Your Page Content Here -->
</section>

<section class="content">
    <!-- Your Page Content Here -->
</section><!-- /.content -->
<script>
    //saving the data
    $(document).ready(function () {
        debugger;
        $('.AddNew').show();
        $('.Save').show();
        $('.Search').show();
        SetActive("mobicash", "retailersmobicash", "retailersmobicash");
    });

    $('#TotalLoad').on('focus', function () {

        $('#TotalLoad').val("0");
        $('#TotalBack').val("0");

        $('.AddGrid2  > tr').each(function (index , row)
        {
            debugger;
            var val = parseFloat($(this).find('.loadsent').val());
            var bval = parseFloat($('#TotalLoad').val());
            var fval = parseFloat(val + bval);
            if (isNaN(fval))
            {
                $('#TotalLoad').val(bval);
            }
            else
            {
                $('#TotalLoad').val(fval);
            }

            var val1 = parseFloat($(this).find('.loadback').val());
            var bval1 = parseFloat($('#TotalBack').val());
            var fval1 = parseFloat(val1 + bval1);
            if (isNaN(fval1)) {
                $('#TotalBack').val(bval1);
            }
            else {
                $('#TotalBack').val(fval1);
            }
           
        });
        var totalLoad = parseFloat($('#TotalLoad').val());
        var totalBack = parseFloat($('#TotalBack').val());
        $('#TotalBalance').val(totalLoad - totalBack);
    });

    $('#DistributorId').live('change', function () {
        var id = $('#DistributorId :selected').val();
        var url = '@Url.Action("GetRetailers", "Sales")';
        var Data = JSON.stringify({ Id:id });
        var DataList = showGridData(Data, url);
        var GetData = JSON.parse(DataList);
        $('.AddGrid2').html('');

        for (var i = 0; i < GetData.length ; i++) {
            var row = "<tr class='NewRow'>"
                                  + '<td style="background:#d5d6d9; text-align:center;">' + (parseInt(i)+1) + '</td>'
                                  + '<td><input id="" name="Name" readonly class="form-control tdtext-fld-height" value="' + GetData[i].Name + '" type="text"><input type="hidden" id="" class="id" value="' + GetData[i].Id + '" /></td>'
                                  + '<td><input id="" name="Phone" readonly class="form-control tdtext-fld-height"  value="' + GetData[i].Phone + '" type="text"></td>'
                                  + '<td><input id="loadsent" name="LoadSent" class="form-control loadsent Numeric tdtext-fld-height"  value="" type="text"></td>'
                                  + '<td><input id="loadback" name="LoadBack" class="form-control loadback Numeric tdtext-fld-height"  value="" type="text"></td>'
                                  + '<td class="action" style="text-align:center;"><a href="#" class="Delete"><i class="fa fa-times" aria-hidden="true"></i></a></td>'


            "</tr>";
            $('.AddGrid2').append(row);
        }


    });

    $('.Save').on('click', function () {
        var _Id = "#SimpleData";
        var validationFrm = "SimpleData";
        var _Class = ".NewRow";
        var Url = '@Url.Action("SaveMobiRecord", "Sales")';
        SaveDataMultiObj(_Id, validationFrm, _Class, Url);
    });



    $('.AddNew').on('click', function () {
        $('.Save').show();
        $('#form1 , .form1').slideDown();
        $('.form2').slideUp();
    });
       

    $('.Delete').on('click', function () {
        debugger;
        var id = $('.id').val().trim();
        var Url = '@Url.Action("DeleteUser", "User")';
        DeleteRecord(id, Url);
    });
    $('.Search').on('click', function () {
        $('#form1 , .form1').slideUp();
        enabledAll();
        $('.form2').slideDown();
        $('.Save').hide();
    });
   
    $('.SearchLoad').live('click', function () {
        debugger;
        var date = $('#PDate').val();
        var doId = $('#DistributorId1 :selected').val();
        var url = '@Url.Action("GetMobiRecord", "Sales")';
        var Data = JSON.stringify({ date: date, doId: doId });
        var GetData = showGridData(Data, url);
        var obj = JSON.parse(GetData);

        $('#bal').val(obj.Balance);
        $('#tback').val(obj.TBack);
        $('#tload').val(obj.TLoad);

        var RetailerRecords = GetRetailerRecords(obj.Id);

        $('.AddGrid').html('');
        for (var i = 0; i <= RetailerRecords.length; i++) {

            //var currentTime = new Date(parseInt(GetData[i].Date.substr(6)));
            //var month = currentTime.getMonth() + 1;
            //var day = currentTime.getDate();
            //var year = currentTime.getFullYear();
            //var date = day + "/" + month + "/" + year;
            debugger;
            var row = "<tr>"
                                    + '<td style="background:#d5d6d9; text-align:center;"></td>'
                                  //  + '<td><input class="form-control tdtext-fld-height" value="' + date + '" type="text"><input type="hidden" class="id" value="' + GetData[i].Id + '" /></td>'
                                    + '<td><input readonly class="form-control tdtext-fld-height"  value="' + RetailerRecords[i].Name + '" type="text"></td>'
                                    + '<td><input readonly class="form-control tdtext-fld-height"  value="' + RetailerRecords[i].Phone + '" type="text"></td>'
                                    + '<td><input readonly class="form-control tdtext-fld-height"  value="' + RetailerRecords[i].LoadSent + '" type="text"></td>'
                                    + '<td><input readonly class="form-control tdtext-fld-height"  value="' + RetailerRecords[i].LoadBack + '" type="text"></td>'

                                        + '<td class="action" style="text-align:center;"><a href="#" class="Delete"><i class="fa fa-times" aria-hidden="true"></i></a></td>'


            "</tr>";
            $('.AddGrid').append(row);
        }
      
    });

    function GetRetailerRecords(RecId)
    {
        var url = '@Url.Action("GetRetailerRecord", "Sales")';
        var Data = JSON.stringify({ RecId: RecId });
        var GetData = showGridData(Data, url);
        var obj = JSON.parse(GetData);
        return obj;
    }

    
</script>
